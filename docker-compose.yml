version: '3.8'

services:
  # 1. SERVIÇO DE BANCO DE DADOS (MongoDB) - NOVO
  mongo:
    image: mongo:6
    container_name: projeto02_mongo
    restart: always
    ports:
      - "27017:27017" # Porta padrão do MongoDB para debug, se necessário
    volumes:
      - mongo_data:/data/db # Volume persistente para dados

  # 2. SERVIÇO DE CACHE (Redis) - CORRIGIDO
  redis:
    image: redis:6.2-alpine
    container_name: projeto02_redis
    restart: always

  # 3. SERVIÇO DE BACKEND (Node.js/Express) - CORRIGIDO
  backend:
    container_name: projeto02_backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    # ENTRYPOINT: Roda instalações, seed e inicia o servidor
    entrypoint: /bin/sh -c "npm install && npm run seed && npm start" 
    ports:
       # Expor a porta 3000 para acesso direto do Frontend
       - "3000:3000" 
    volumes:
      - ./backend:/app
      - /app/node_modules
    environment:
      # URL de conexão com o container 'mongo'
      MONGO_URI: mongodb://mongo:27017/projeto02_db
      REDIS_URL: redis://redis:6379
    depends_on:
      - mongo
      - redis

volumes:
  mongo_data: # NOVO VOLUME